name: Persistent-VPS
on:
  workflow_dispatch: # ูุชุดุบููู ูุฏููุงู ููุง ุทูุจุช ูู ุดูุฑ
  schedule:
    - cron: '0 */6 * * *' # ูุนูุฏ ุชุดุบูู ููุณู ูู 6 ุณุงุนุงุช ูุถูุงู ุงูุงุณุชูุฑุงุฑูุฉ

jobs:
  secure-vps:
    runs-on: ubuntu-latest
    timeout-minutes: 0 # ุชู ุชุนุทูู ุงููููุฉ ุงูุฒูููุฉ ูููุน ุงูุชููู ุงูุชููุงุฆู
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Restore Data
        run: |
          # ุงุณุชุนุงุฏุฉ ุงูุจูุงูุงุช ุงููุญููุธุฉ
          git config --global user.name "VPS-Bot"
          git config --global user.email "bot@vps.com"
          # ุงุณุชุฎุฏุงู ูุณุงุฑ ุจุฏูู ูููู ุงููุตูู ุฅููู
          mkdir -p $HOME/my_data
          echo "โ ุชู ุฅูุดุงุก ุฏููู ุงูุจูุงูุงุช ูู: $HOME/my_data"

      - name: Install & Configure SSH
        run: |
          sudo apt update -y
          sudo apt install -y openssh-server curl
          sudo systemctl enable ssh
          sudo systemctl start ssh
          echo "root:admin@123" | sudo chpasswd
          echo "PermitRootLogin yes" | sudo tee -a /etc/ssh/sshd_config
          sudo service ssh restart
          echo "โ SSH user: root | pass: admin@123"

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=persistent-vps --advertise-exit-node
          tsIP=$(tailscale ip -4 | head -n 1)
          echo "TAILSCALE_IP=$tsIP" >> $GITHUB_ENV
          echo "โ Tailscale IP: $tsIP"

      - name: Send Telegram Notification
        run: |
          # ุฅุนุฏุงุฏ ุจูุงูุงุช ุงูุจูุช
          BOT_TOKEN="8541707577:AAHivkWH7RdHhKr8zXSuL_roy245LmNYyRo"
          CHAT_ID="7259620384"
          VPS_IP="$TAILSCALE_IP"
          
          # ุฅูุดุงุก ุฑุณุงูุฉ ุงูุชููุฌุฑุงู
          MESSAGE="๐ *VPS ุฌุฏูุฏ ุฌุงูุฒ ููุงุณุชุฎุฏุงู* ๐

๐ก *ุนููุงู ุงูู IP:* \`$VPS_IP\`
๐ฅ๏ธ *ุงุณู ุงููุณุชุฎุฏู:* \`root\`
๐ *ูููุฉ ุงููุฑูุฑ:* \`admin@123\`

โฑ๏ธ *ูุฏุฉ ุงูุชุดุบูู:* ุบูุฑ ูุญุฏูุฏุฉ
๐ *ุฅุนุงุฏุฉ ุงูุชุดุบูู:* ูู 6 ุณุงุนุงุช
๐ *ููุณ ุงูู IP:* ูุนู

๐ *ุทุฑููุฉ ุงูุงุชุตุงู:*
\`\`\`
ssh root@$VPS_IP
\`\`\`

๐ *ุชุงุฑูุฎ ุงูุจุฏุก:* $(date '+%Y-%m-%d %H:%M:%S')
๐ *ูุนุฑู ุงูุฌูุณุฉ:* ${{ github.run_id }}"
          
          # ุฅุฑุณุงู ุงูุฑุณุงูุฉ ุฅูู ุงูุชููุฌุฑุงู
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            -d chat_id="${CHAT_ID}" \
            -d text="${MESSAGE}" \
            -d parse_mode="Markdown" \
            -d disable_web_page_preview="true" || echo "โ๏ธ ูุฏ ูููู ููุงู ูุดููุฉ ูู ุฅุฑุณุงู ุงูุชููุฌุฑุงู"
          
          echo "โ ุชู ุฅุฑุณุงู ุฅุดุนุงุฑ ุงูุชููุฌุฑุงู ุจูุฌุงุญ!"

      - name: Background Auto-Save
        run: |
          # ุณูุฑูุจุช ูุนูู ูู ุงูุฎูููุฉ ูุญูุธ ุจูุงูุงุชู
          cat << 'EOF' > /tmp/save_data.sh
          #!/bin/bash
          while true; do
            echo "$(date) - ุญูุธ ุงูุจูุงูุงุช ุงูุชููุงุฆู..."
            # ุฃุถู ููุง ุฃูุงูุฑ ุงูุญูุธ ุงูุฎุงุตุฉ ุจู
            sleep 600
          done
          EOF
          
          # ุฅุนุทุงุก ุตูุงุญูุงุช ุงูุชูููุฐ
          chmod +x /tmp/save_data.sh
          
          # ุชุดุบูู ุงูุณูุฑูุจุช ูู ุงูุฎูููุฉ
          /tmp/save_data.sh > /tmp/save_log.txt 2>&1 &
          
          echo "โ ุชู ุชุดุบูู ุณูุฑูุจุช ุงูุญูุธ ุงูุชููุงุฆู ูู ุงูุฎูููุฉ"

      - name: Keep VPS Alive Forever
        run: |
          echo "========================================="
          echo "๐ VPS ุฌุงูุฒ ููุงุณุชุฎุฏุงู!"
          echo "๐ก Tailscale IP: $TAILSCALE_IP"
          echo "๐ฅ๏ธ  SSH: root@$TAILSCALE_IP"
          echo "๐ ูููุฉ ุงููุฑูุฑ: admin@123"
          echo "โฑ๏ธ  ุงููููุฉ ุงูุฒูููุฉ: ุบูุฑ ูุญุฏูุฏ"
          echo "๐ฑ ุฅุดุนุงุฑุงุช ุงูุชููุฌุฑุงู: ููุนูุฉ โ"
          echo "๐ค ูุนุฑู ุงูุชููุฌุฑุงู: 7259620384"
          echo "========================================="
          echo ""
          echo "โ ุงูุฌูุณุฉ ุณุชุจูู ููุฏ ุงูุชุดุบูู ุฅูู ูุง ูุง ููุงูุฉ"
          echo "โ ุณูุชู ุงูุญูุงุธ ุนูู ููุณ IP ูู ูู ุฌูุณุฉ"
          echo ""
          echo "๐ ููุงุชุตุงู ุนุจุฑ SSH ุงุณุชุฎุฏู:"
          echo "ssh root@$TAILSCALE_IP"
          echo ""
          echo "[$(date)] ุจุฏุก ุงูุชุดุบูู..."
          
          # ุญููุฉ ูุง ููุงุฆูุฉ ููุญูุงุธ ุนูู ุงูุฌูุณุฉ
          counter=1
          while true; do
            echo "[$(date)] VPS ูุนูู ุจุฏูู ุชููู... (ุงูุฏูููุฉ: $counter)"
            sleep 60
            counter=$((counter + 1))
          done
