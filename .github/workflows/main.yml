name: Persistent-VPS
on:
  workflow_dispatch: # Ù„ØªØ´ØºÙŠÙ„Ù‡ ÙŠØ¯ÙˆÙŠØ§Ù‹
  schedule:
    - cron: '0 */6 * * *' # ÙŠØ¹ÙŠØ¯ ØªØ´ØºÙŠÙ„ Ù†ÙØ³Ù‡ ÙƒÙ„ 6 Ø³Ø§Ø¹Ø§Øª

jobs:
  secure-vps:
    runs-on: ubuntu-latest
    timeout-minutes: 0 # Ù„Ø§ ÙŠØªÙˆÙ‚Ù ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
    
    steps:
      - name: ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯
        uses: actions/checkout@v3

      - name: âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        run: |
          git config --global user.name "VPS-Bot"
          git config --global user.email "bot@vps.com"
          mkdir -p /home/runner/my_data
          echo "âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"

      - name: ğŸ” Ø¥Ø¹Ø¯Ø§Ø¯ SSH
        run: |
          sudo apt update -y
          sudo apt install -y openssh-server curl
          
          # Ø¥Ø¹Ø¯Ø§Ø¯ SSH
          sudo mkdir -p /var/run/sshd
          echo "root:admin@123" | sudo chpasswd
          echo "PermitRootLogin yes" | sudo tee -a /etc/ssh/sshd_config
          
          # ØªØ´ØºÙŠÙ„ SSH
          sudo ssh-keygen -A
          sudo /usr/sbin/sshd
          
          echo "âœ… SSH Ø¬Ø§Ù‡Ø²"
          echo "ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: root"
          echo "ğŸ”‘ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±: admin@123"

      - name: ğŸ“¡ Ø¥Ø¹Ø¯Ø§Ø¯ Tailscale
        run: |
          # ØªØ«Ø¨ÙŠØª Tailscale
          curl -fsSL https://tailscale.com/install.sh | sudo sh
          
          # ØªØ´ØºÙŠÙ„ Tailscale
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=github-vps
          
          # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ IP
          sleep 10
          TS_IP=$(sudo tailscale ip -4)
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV
          echo "âœ… Tailscale IP: $TS_IP"

      - name: ğŸ“¨ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù…
        run: |
          BOT_TOKEN="8541707577:AAHivkWH7RdHhKr8zXSuL_roy245LmNYyRo"
          CHAT_ID="7259620384"
          IP="$TAILSCALE_IP"
          
          # ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ IP
          if [ -z "$IP" ]; then
            IP="Ø¬Ø§Ø±Ù Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ IP..."
          fi
          
          # Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
          MESSAGE="ğŸš€ *ØªÙ… ØªØ´ØºÙŠÙ„ VPS Ø¬Ø¯ÙŠØ¯* ğŸš€

ğŸ“¡ *IP Address:* \`$IP\`
ğŸ‘¤ *Username:* \`root\`
ğŸ”‘ *Password:* \`admin@123\`

ğŸ”— *Connection Command:*
\`\`\`
ssh root@$IP
\`\`\`

â° *Start Time:* $(date '+%Y-%m-%d %H:%M:%S')
ğŸ†” *Session ID:* ${{ github.run_id }}

âš ï¸ *Keep your credentials secure!*"
          
          # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            -d chat_id="$CHAT_ID" \
            -d text="$MESSAGE" \
            -d parse_mode="Markdown"
          
          echo "âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù…"

      - name: ğŸ”„ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙƒØ±ÙŠØ¨Øª Ø§Ù„Ø®Ù„ÙÙŠ
        run: |
          # Ø¥Ù†Ø´Ø§Ø¡ Ø³ÙƒØ±ÙŠØ¨Øª Ø¨Ø³ÙŠØ· Ù„Ù„Ø®Ù„ÙÙŠØ©
          cat > /home/runner/background.sh << 'EOF'
          #!/bin/bash
          echo "ğŸ”„ Ø¨Ø¯Ø¡ Ø§Ù„Ø³ÙƒØ±ÙŠØ¨Øª Ø§Ù„Ø®Ù„ÙÙŠ"
          while true; do
            echo "$(date) - VPS Ù†Ø´Ø·"
            sleep 300
          done
          EOF
          
          chmod +x /home/runner/background.sh
          nohup /home/runner/background.sh > /home/runner/bg.log 2>&1 &
          
          echo "âœ… Ø§Ù„Ø³ÙƒØ±ÙŠØ¨Øª Ø§Ù„Ø®Ù„ÙÙŠ ÙŠØ¹Ù…Ù„"

      - name: âš¡ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ ØªØ´ØºÙŠÙ„ VPS
        run: |
          echo "=========================================="
          echo "ğŸ‰ VPS Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…!"
          echo "=========================================="
          echo ""
          echo "ğŸ“Š Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„:"
          echo "   ğŸ“ IP Address: $TAILSCALE_IP"
          echo "   ğŸ‘¤ Username: root"
          echo "   ğŸ”‘ Password: admin@123"
          echo ""
          echo "ğŸ”— Ù„Ø£ØªØµØ§Ù„ SSH:"
          echo "   ssh root@$TAILSCALE_IP"
          echo ""
          echo "â° ÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø¡: $(date)"
          echo "ğŸ”„ Ø§Ù„Ù…Ø¯Ø©: ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯Ø©"
          echo "=========================================="
          
          # Ø­Ù„Ù‚Ø© Ù„Ø§ Ù†Ù‡Ø§Ø¦ÙŠØ© Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„ØªØ´ØºÙŠÙ„
          counter=0
          while true; do
            counter=$((counter + 1))
            echo "â³ VPS ÙŠØ¹Ù…Ù„... (Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø©: $counter)"
            
            # Ø¹Ø±Ø¶ IP ÙƒÙ„ 5 Ø¯Ù‚Ø§Ø¦Ù‚
            if [ $((counter % 5)) -eq 0 ]; then
              CURRENT_IP=$(sudo tailscale ip -4 2>/dev/null || echo "$TAILSCALE_IP")
              echo "   ğŸ“ IP Ø§Ù„Ø­Ø§Ù„ÙŠ: $CURRENT_IP"
            fi
            
            sleep 60
          done
