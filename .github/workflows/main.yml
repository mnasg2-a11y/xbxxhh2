name: Persistent-VPS
on:
  workflow_dispatch: # ูุชุดุบููู ูุฏููุงู ููุง ุทูุจุช ูู ุดูุฑ
  schedule:
    - cron: '0 */6 * * *' # ูุนูุฏ ุชุดุบูู ููุณู ูู 6 ุณุงุนุงุช ูุถูุงู ุงูุงุณุชูุฑุงุฑูุฉ

jobs:
  secure-vps:
    runs-on: ubuntu-latest
    timeout-minutes: 0 # ุชู ุชุนุทูู ุงููููุฉ ุงูุฒูููุฉ ูููุน ุงูุชููู ุงูุชููุงุฆู
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Restore Data
        run: |
          # ุงุณุชุนุงุฏุฉ ุงูุจูุงูุงุช ุงููุญููุธุฉ ูู ูุฑุน (branch) ุฎุงุต ุจุงูุจูุงูุงุช
          git config --global user.name "VPS-Bot"
          git config --global user.email "bot@vps.com"
          # ุงุณุชุฎุฏุงู ูุณุงุฑ ุจุฏูู ูููู ุงููุตูู ุฅููู
          mkdir -p $HOME/my_data
          echo "โ ุชู ุฅูุดุงุก ุฏููู ุงูุจูุงูุงุช ูู: $HOME/my_data"

      - name: Install & Configure SSH
        run: |
          sudo apt update -y
          sudo apt install -y openssh-server
          sudo systemctl enable ssh
          sudo systemctl start ssh
          echo "root:admin@123" | sudo chpasswd
          echo "PermitRootLogin yes" | sudo tee -a /etc/ssh/sshd_config
          sudo service ssh restart
          echo "โ SSH user: root | pass: admin@123"

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=persistent-vps --advertise-exit-node
          tsIP=$(tailscale ip -4 | head -n 1)
          echo "TAILSCALE_IP=$tsIP" >> $GITHUB_ENV
          echo "โ Tailscale IP: $tsIP"

      - name: Background Auto-Save
        run: |
          # ุณูุฑูุจุช ูุนูู ูู ุงูุฎูููุฉ ูุญูุธ ุจูุงูุงุชู ูู 10 ุฏูุงุฆู
          cat << 'EOF' > /tmp/save_data.sh
          while true; do
            echo "$(date) - Saving data to GitHub..."
            # ุฃุถู ููุง ุงูุฃูุงูุฑ ุงูุชู ุชุญูุธ ูููุงุชู ุงููููุฉ ุฅูู ุงููุณุชูุฏุน
            sleep 600
          done
          EOF
          
          # ุฅุนุทุงุก ุตูุงุญูุงุช ุงูุชูููุฐ
          chmod +x /tmp/save_data.sh
          
          # ุชุดุบูู ุงูุณูุฑูุจุช ูู ุงูุฎูููุฉ
          /tmp/save_data.sh &
          
          echo "โ ุชู ุชุดุบูู ุณูุฑูุจุช ุงูุญูุธ ุงูุชููุงุฆู ูู ุงูุฎูููุฉ"

      - name: Keep VPS Alive Forever
        run: |
          echo "========================================="
          echo "๐ VPS ุฌุงูุฒ ููุงุณุชุฎุฏุงู!"
          echo "๐ก Tailscale IP: $TAILSCALE_IP"
          echo "๐ฅ๏ธ  SSH: root@$TAILSCALE_IP"
          echo "๐ ูููุฉ ุงููุฑูุฑ: admin@123"
          echo "โฑ๏ธ  ุงููููุฉ ุงูุฒูููุฉ: ุบูุฑ ูุญุฏูุฏ"
          echo "========================================="
          echo ""
          echo "โ ุงูุฌูุณุฉ ุณุชุจูู ููุฏ ุงูุชุดุบูู ุฅูู ูุง ูุง ููุงูุฉ"
          echo "โ ุณูุชู ุงูุญูุงุธ ุนูู ููุณ IP ูู ูู ุฌูุณุฉ"
          echo "โ ุณูุฑูุจุช ุงูุญูุธ ุงูุชููุงุฆู ูุนูู ูู ุงูุฎูููุฉ"
          echo ""
          echo "๐ ููุงุชุตุงู ุนุจุฑ SSH ุงุณุชุฎุฏู:"
          echo "ssh root@$TAILSCALE_IP"
          echo ""
          echo "[$(date)] ุจุฏุก ุงูุชุดุบูู..."
          
          # ุนุฑุถ ุนููุงู IP ุจุดูู ูุงุถุญ
          echo "========================================="
          echo "๐ ุนููุงู ุงูุงุชุตุงู: $TAILSCALE_IP"
          echo "========================================="
          
          # ุญููุฉ ูุง ููุงุฆูุฉ ููุญูุงุธ ุนูู ุงูุฌูุณุฉ
          counter=1
          while true; do
            echo "[$(date)] VPS ูุนูู ุจุฏูู ุชููู... (ุงูุฏูููุฉ: $counter)"
            # ุนุฑุถ IP ูู 5 ุฏูุงุฆู ููุชุฐููุฑ
            if (( counter % 5 == 0 )); then
              echo "   ๐ IP ุงูุญุงูู: $TAILSCALE_IP"
            fi
            sleep 60
            counter=$((counter + 1))
          done
